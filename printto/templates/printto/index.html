{% extends "printto/base.html" %}

{% load static %}
{% load sass_tags %}

{% block title %}PrintTo{% endblock title %}

{% block head %}
<link href='{% static "dropzonejs/5.2.0/css/basic.min.css" %}' rel="stylesheet">
<link href='{% static "dropzonejs/5.2.0/css/dropzone.min.css" %}' rel="stylesheet">
<script src='{% static "dropzonejs/5.2.0/js/dropzone.min.js" %}'></script>

<script type="text/javascript">

window.onload = function() {
    if(!window.location.hash) {
        window.location = window.location + '#loaded';
        window.location.reload();
    };
};

$(document).ready(function() {
    // Dropzone configurations
    var dzone = new Dropzone("#printerDropzone", {
        paramName: "file", // The name that will be used to transfer the file
        maxFilesize: 100, // MB
        acceptedFiles: "application/pdf",
        addRemoveLinks: true,
        parallelUploads: 1,
        createImageThumbnails: false,
        autoProcessQueue: false,
        accept: function(file, done) {
            fileExt = file.name.split('.').pop();
            if ((fileExt != "pdf") && (fileExt != "PDF")) {
                done("Unsupported file type!");
            } else {
                done();
            }
        },
        dictDefaultMessage: "<h3><strong>Click here or drop files here!</strong><h3>"
    });
});

function resetAutoProcessQueueOption() {
    dzone = Dropzone.forElement("#printerDropzone");
    dzone.options.autoProcessQueue = false;

    // Generate printed file list
    var nowDate = new Date();
    var printedHtml = ""

    files = dzone.getAcceptedFiles()
    if(files.length <= 0) {
        // Ignore non-files situation
        return;
    };

    printedHtml += "<strong>";
    printedHtml += nowDate.toDateString() + "@" + nowDate.toTimeString();
    printedHtml += "<BR />Printed " + String(files.length) + " files";
    printedHtml += "</strong>: <BR />";

    alert(files.length);

    for (i = 0; i < files.length; i++) {
        printedHtml += "<BR />" + String(i) + ": " + files[i].name;
    };
    // Tell what we printed
    $("#printedInfo").html(printedHtml);

    // Clear printed files
    dzone.removeAllFiles();
};

function startUpload() {
    dzone = Dropzone.forElement("#printerDropzone");

    // Disable queue auto processing on upload complete
    dzone.on("queuecomplete", resetAutoProcessQueueOption);
    dzone.options.autoProcessQueue = true;
    dzone.processQueue();
};
</script>
{% endblock%}

{% block content %}
<div class="container">
    <div class="row">
        <button class="btn btn-primary start" onclick="startUpload()">
            <i class="glyphicon glyphicon-upload"></i> <span>Start Print</span>
        </button>
    </div>
    <h4>Queued documents:</h4>
    <form id="printerDropzone"
        action='{% url "index" %}'
        enctype="multipart/form-data"
        method="post"
        class="dropzone">
        {% csrf_token %}
    </form>
    <h4>Printed documents:</h4>
    <div id="printedInfo" class="alert alert-info">
    </div>
</div>
{% endblock content %}

